trigger:
  branches:
    include:
    - main
    - develop

variables:
  azureSubscription: 'Azure-ServiceConnection'
  resourceGroupName: 'rg-banking-aks-prod'
  imageName: 'banking-app'
  k8sNamespace: 'banking'
  vmImageName: 'ubuntu-latest'

stages:
- stage: BuildAndDeploy
  displayName: 'Build and Deploy Application'
  jobs:
  - job: BuildPushDeploy
    displayName: 'Build, Push, and Deploy'
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: AzureCLI@2
      displayName: 'Get Azure Resources Info'
      name: GetResources
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Getting resource information..."
          
          # Get ACR name
          ACR_NAME=$(az acr list --resource-group $(resourceGroupName) --query "[0].name" -o tsv)
          ACR_LOGIN_SERVER=$(az acr list --resource-group $(resourceGroupName) --query "[0].loginServer" -o tsv)
          
          # Get AKS name
          AKS_NAME=$(az aks list --resource-group $(resourceGroupName) --query "[0].name" -o tsv)
          
          # Get Key Vault
          KV_NAME=$(az keyvault list --resource-group $(resourceGroupName) --query "[0].name" -o tsv)
          KV_URI=$(az keyvault list --resource-group $(resourceGroupName) --query "[0].properties.vaultUri" -o tsv)
          
          # Get App Gateway IP
          APP_GW_NAME=$(az network application-gateway list --resource-group $(resourceGroupName) --query "[0].name" -o tsv)
          APP_GW_IP=$(az network public-ip show --resource-group $(resourceGroupName) --name ${APP_GW_NAME%-appgw}-appgw-pip --query ipAddress -o tsv)
          
          echo "Found resources:"
          echo "  ACR: $ACR_NAME"
          echo "  AKS: $AKS_NAME"
          echo "  Key Vault: $KV_NAME"
          echo "  App Gateway IP: $APP_GW_IP"
          
          # Export as pipeline variables
          echo "##vso[task.setvariable variable=acrName;isOutput=true]$ACR_NAME"
          echo "##vso[task.setvariable variable=acrLoginServer;isOutput=true]$ACR_LOGIN_SERVER"
          echo "##vso[task.setvariable variable=aksName;isOutput=true]$AKS_NAME"
          echo "##vso[task.setvariable variable=keyVaultUri;isOutput=true]$KV_URI"
          echo "##vso[task.setvariable variable=appGatewayIp;isOutput=true]$APP_GW_IP"

    - task: AzureCLI@2
      displayName: 'Login to ACR and Build Image'
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          ACR_NAME="$(GetResources.acrName)"
          ACR_SERVER="$(GetResources.acrLoginServer)"
          
          echo "ACR Name: $ACR_NAME"
          echo "ACR Server: $ACR_SERVER"
          
          # Login to ACR
          az acr login --name $ACR_NAME
          
          # Build image
          cd $(Build.SourcesDirectory)/app
          docker build -t $(imageName):$(Build.BuildNumber) .
          docker tag $(imageName):$(Build.BuildNumber) $(imageName):latest
          
          # Tag for ACR
          docker tag $(imageName):$(Build.BuildNumber) $ACR_SERVER/$(imageName):$(Build.BuildNumber)
          docker tag $(imageName):$(Build.BuildNumber) $ACR_SERVER/$(imageName):latest
          
          # Push to ACR
          docker push $ACR_SERVER/$(imageName):$(Build.BuildNumber)
          docker push $ACR_SERVER/$(imageName):latest
          
          echo "Image pushed: $ACR_SERVER/$(imageName):$(Build.BuildNumber)"

    - task: AzureCLI@2
      displayName: 'Deploy to AKS'
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          AKS_NAME="$(GetResources.aksName)"
          ACR_SERVER="$(GetResources.acrLoginServer)"
          KV_URI="$(GetResources.keyVaultUri)"
          
          echo "Deploying to AKS: $AKS_NAME"
          
          # Get AKS credentials
          az aks get-credentials \
            --resource-group $(resourceGroupName) \
            --name $AKS_NAME \
            --overwrite-existing
          
          # Verify connection
          kubectl cluster-info
          kubectl get nodes
          
          # Create namespace
          kubectl create namespace $(k8sNamespace) --dry-run=client -o yaml | kubectl apply -f -
          
          # Update manifests
          cd $(Build.SourcesDirectory)/k8s
          
          # Update deployment with image
          sed -i "s|image:.*|image: $ACR_SERVER/$(imageName):$(Build.BuildNumber)|g" 03-deployment.yaml
          
          # Update secret with Key Vault URI
          sed -i "s|__KEY_VAULT_URL__|$KV_URI|g" 01-secret.yaml
          
          # Apply manifests
          kubectl apply -f 00-namespace.yaml
          kubectl apply -f 01-secret.yaml -n $(k8sNamespace)
          kubectl apply -f 02-configmap.yaml -n $(k8sNamespace)
          kubectl apply -f 03-deployment.yaml -n $(k8sNamespace)
          kubectl apply -f 04-service.yaml -n $(k8sNamespace)
          kubectl apply -f 05-hpa.yaml -n $(k8sNamespace)
          kubectl apply -f 06-network-policy.yaml -n $(k8sNamespace)
          
          # Wait for deployment
          echo "Waiting for deployment to complete..."
          kubectl rollout status deployment/banking-app -n $(k8sNamespace) --timeout=10m
          
          # Get service info
          echo "Checking pods..."
          kubectl get pods -n $(k8sNamespace)
          
          echo "Checking service..."
          kubectl get svc banking-app-service -n $(k8sNamespace)

    - task: AzureCLI@2
      displayName: 'Configure Application Gateway'
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Waiting for LoadBalancer IP..."
          
          # Wait for LoadBalancer IP
          for i in {1..30}; do
            INTERNAL_LB_IP=$(kubectl get svc banking-app-service -n $(k8sNamespace) -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
            
            if [ -n "$INTERNAL_LB_IP" ]; then
              echo "LoadBalancer IP assigned: $INTERNAL_LB_IP"
              break
            fi
            
            echo "Waiting... (attempt $i/30)"
            sleep 10
          done
          
          if [ -z "$INTERNAL_LB_IP" ]; then
            echo "Warning: LoadBalancer IP not assigned after 5 minutes"
            exit 0
          fi
          
          # Update Application Gateway backend pool
          echo "Updating Application Gateway backend pool..."
          
          APP_GW_NAME=$(az network application-gateway list --resource-group $(resourceGroupName) --query "[0].name" -o tsv)
          
          az network application-gateway address-pool update \
            --gateway-name $APP_GW_NAME \
            --resource-group $(resourceGroupName) \
            --name backend-pool \
            --servers $INTERNAL_LB_IP
          
          echo "Application Gateway updated successfully!"

    - task: Bash@3
      displayName: 'Deployment Summary'
      inputs:
        targetType: 'inline'
        script: |
          APP_GW_IP="$(GetResources.appGatewayIp)"
          
          echo "============================================"
          echo "‚úÖ DEPLOYMENT SUCCESSFUL!"
          echo "============================================"
          echo ""
          echo "üåê Application URL:"
          echo "   http://$APP_GW_IP"
          echo ""
          echo "üîê Login Credentials:"
          echo "   Customer ID: 5439090"
          echo "   Password: Passw0rd!!"
          echo ""
          echo "üìä Deployment Details:"
          echo "   Resource Group: $(resourceGroupName)"
          echo "   AKS Cluster: $(GetResources.aksName)"
          echo "   Namespace: $(k8sNamespace)"
          echo "   Build Number: $(Build.BuildNumber)"
          echo "   Image: $(GetResources.acrLoginServer)/$(imageName):$(Build.BuildNumber)"
          echo ""
          echo "üîç Verify Deployment:"
          echo "   kubectl get all -n $(k8sNamespace)"
          echo "   kubectl logs -f deployment/banking-app -n $(k8sNamespace)"
          echo ""
          echo "============================================"
